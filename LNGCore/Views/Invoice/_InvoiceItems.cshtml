@model LNGCore.UI.Models.Admin.InvoiceViewModel
@using static LNGCore.Domain.Infrastructure.Enums
<div class="card semi-transparent rounded-0 border-top-0">
    <div class="card-header semi-transparent">
        <h4 class="m-0">@Model.ViewTitle</h4>
    </div>
    <div class="card-body">
        @if (Model.Invoices.Any())
        {
        if (Model.PaginationParameters.NumberOfPages > 1)
        {
        <partial name="_Pagination" model="Model.PaginationParameters" />
        }

        foreach (var invoice in Model.Invoices)
        {
        <div class="pb-2" id="invoice@(invoice.Id)">
            <div class="card semi-transparent">
                <div class="card-body slight-border p-2">
                    <div class="row no-gutters">
                        <div class="col-lg-2 text-center text-left-lg">
                            <span data-toggle="collapse" role="button" data-target="@($"#collapse{invoice.Id}")">
                                <span class="h5 d-lg-block m-0 pointer" data-toggle="tooltip" data-placement="left" title="Customer #@invoice.CustomerId">@invoice.Customer.Name</span>
                            </span>
                        </div>
                        <div class="col-lg-3 text-center">
                            <small class="text-info d-none d-lg-block">
                                Ordered <span class="font-weight-bold">@invoice.OrderDate.ToString("d")</span>
                            </small>
                            <small class="text-danger d-block">
                                Needed <span class="font-weight-bold">@invoice.OrderDate.ToString("d")</span>
                            </small>
                            <small class="text-success d-block pointer" onclick="openEmailHistory(@invoice.Id)">
                                Emailed @(Model.InvoiceEmailCounts[invoice.Id]) Time@(Model.InvoiceEmailCounts[invoice.Id] == 1 ? "" : "s")
                            </small>
                            <hr class="d-lg-none my-1" />
                        </div>
                        <div class="col-lg-5 pr-lg-4">
                            <small>
                                @(string.IsNullOrWhiteSpace(invoice.Notes) ? "No Notes." : invoice.Notes)
                            </small>
                        </div>
                        <div class="col-lg-2 text-right">
                            <small class="text-secondary">@($"{invoice.LineItem.Count()} Item{(invoice.LineItem.Count() > 1 ? "s" : "")} | #{@invoice.Id}")</small>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-info dropdown-toggle" data-display="static" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    I Want To...
                                </button>
                                <div class="dropdown-menu dropdown-menu-right text-right" aria-labelledby="dropdownMenuButton">
                                    @if (invoice.IsPaid != true)
                                    {
                                    <span class="pointer dropdown-item" onclick="setStatus(@invoice.Id, 'Paid');">
                                        Set As Paid
                                        <span class="icon-width text-center text-success fas fa-dollar-sign"></span>
                                    </span>
                                    }
                                    @if (invoice.Voided || invoice.IsQuote || invoice.IsPaid == true || invoice.IsDonated == true)
                                    {
                                    <span class="pointer dropdown-item" onclick="setStatus(@invoice.Id, 'Open');">
                                        Set As Open
                                        <span class="icon-width text-center text-info-light fas fa-book-open"></span>
                                    </span>
                                    }
                                    @if (invoice.IsDonated != true)
                                    {
                                    <span class="pointer dropdown-item" onclick="setStatus(@invoice.Id, 'Donated');">
                                        Set As Donated
                                        <span class="icon-width text-center text-pink fas fa-gift"></span>
                                    </span>
                                    }
                                    @if (!invoice.IsQuote)
                                    {
                                    <span class="pointer dropdown-item" onclick="setStatus(@invoice.Id, 'Quote');">
                                        Set As Quote
                                        <span class="icon-width text-center text-purple fas fa-quote-left"></span>
                                    </span>
                                    }
                                    @if (!invoice.Voided)
                                    {
                                    <span class="pointer dropdown-item" onclick="setStatus(@invoice.Id, 'Voided');">
                                        Void Invoice
                                        <span class="icon-width text-center text-danger fas fa-trash"></span>
                                    </span>
                                    }
                                    <hr class="border-secondary m-1 mx-4" />
                                    <a class="pointer dropdown-item" href="@Url.Action("EditInvoice", "Invoice" , new { invoiceId=invoice.Id })">
                                        Edit Invoice
                                        <span class="icon-width text-center text-lime fas fa-edit"></span>
                                    </a>
                                    <a class="pointer dropdown-item" href="@Url.Action("ViewInvoice", "Invoice" , new { invoiceId=invoice.Id })">
                                        Print/Email Invoice
                                        <span class="icon-width text-center text-info far fa-file-alt"></span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer p-0 collapse" id="@($"collapse{invoice.Id}")">
                    <table class="table table-striped table-borderless table-sm m-0" style="background-color:rgba(38, 37, 49, 0.80);">
                        <thead>
                            <tr>
                                <th>Qty.</th>
                                <th>Type</th>
                                <th>Desc</th>
                                <th>$/ea</th>
                            </tr>
                        </thead>
                        @foreach (var item in invoice.LineItem)
                        {
                        <tr>
                            <td>@item.Quantity</td>
                            <td>@item.Item?.ItemName</td>
                            <td>@item.ItemDesc</td>
                            <td>@($"{item.ItemPrice:c}")</td>
                        </tr>
                        }
                    </table>
                </div>
            </div>
        </div>
        }
        if (Model.PaginationParameters.NumberOfPages > 1)
        {
        <partial name="_Pagination" model="Model.PaginationParameters" />
        }

        }
        else
        {
        var searchTermText = $" for search term \"{Model.SearchTerm}\"";
        <h2 class="text-center">@($"No Items Found{(string.IsNullOrWhiteSpace(Model.SearchTerm) ? "" : searchTermText)}.")</h2>
        }
    </div>
</div>


<script>
    function setStatus(invoiceId, status) {
        $.ajax({
            url: "@Html.Raw(Url.Action("SetInvoiceStatus", "Invoice", new { invoiceId = "__INVOICE__", status = "__STATUS__" }))"
                .replace("__INVOICE__", invoiceId).replace("__STATUS__", status),
            success: function () {
                toastr.success("Moved invoice #" + invoiceId + " to " + status);
                $("#invoice" + invoiceId).remove();
            },
            error: function () {
                toastr.error("Something went wrong, the invoice could not be moved.");
            }
        });
    }
    function openEmailHistory(invoiceId) {
        $.ajax({
            url: "@Url.Action("GetInvoiceEmailHistory", "Invoice", new { invoiceId = "__IID__" })".replace("__IID__", invoiceId),
            success: function (html) {
                $("#bs-modal .modal-body").html(html);
                $("#bs-modal").modal("show");
            }
        });
    }
</script>